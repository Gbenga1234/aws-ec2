<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IT Consulting Portal</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #667eea;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .auth-container {
            max-width: 400px;
            margin: 100px auto;
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .auth-container h2 {
            color: #667eea;
            margin-bottom: 30px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .error {
            color: #dc3545;
            font-size: 14px;
            margin-top: 10px;
        }

        .success {
            color: #28a745;
            font-size: 14px;
            margin-top: 10px;
        }

        .dashboard {
            display: none;
        }

        .dashboard.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .stat-card .number {
            font-size: 36px;
            font-weight: bold;
            color: #667eea;
        }

        .tickets-section {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .tickets-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .tickets-header h2 {
            color: #333;
        }

        .ticket-list {
            list-style: none;
        }

        .ticket-item {
            background: #f8f9fa;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 5px;
            border-left: 4px solid #667eea;
            cursor: pointer;
            transition: all 0.3s;
        }

        .ticket-item:hover {
            transform: translateX(5px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .ticket-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .ticket-title {
            font-weight: bold;
            color: #333;
            font-size: 16px;
        }

        .ticket-badges {
            display: flex;
            gap: 10px;
        }

        .badge {
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-urgent {
            background: #dc3545;
            color: white;
        }

        .badge-high {
            background: #fd7e14;
            color: white;
        }

        .badge-medium {
            background: #ffc107;
            color: #333;
        }

        .badge-low {
            background: #28a745;
            color: white;
        }

        .badge-open {
            background: #007bff;
            color: white;
        }

        .badge-in_progress {
            background: #ffc107;
            color: #333;
        }

        .badge-closed {
            background: #6c757d;
            color: white;
        }

        .ticket-description {
            color: #666;
            margin-bottom: 10px;
        }

        .ticket-meta {
            color: #999;
            font-size: 12px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: #333;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        .close-btn:hover {
            color: #333;
        }

        .comments-section {
            margin-top: 30px;
            border-top: 1px solid #ddd;
            padding-top: 20px;
        }

        .comment {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .comment-header {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .comment-time {
            font-size: 12px;
            color: #999;
        }

        .hidden {
            display: none;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
    </style>
</head>
<body>
    <!-- Auth Container -->
    <div id="authContainer" class="auth-container">
        <h2>IT Consulting Portal</h2>
        <div id="loginForm">
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="loginEmail" placeholder="Enter your email">
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="loginPassword" placeholder="Enter your password">
            </div>
            <button class="btn btn-primary" style="width: 100%;" onclick="login()">Login</button>
            <div id="loginError" class="error"></div>
            <p style="text-align: center; margin-top: 20px;">
                Don't have an account? <a href="#" onclick="showRegister(); return false;">Register</a>
            </p>
        </div>
        <div id="registerForm" class="hidden">
            <div class="form-group">
                <label>Full Name</label>
                <input type="text" id="regName" placeholder="Enter your full name">
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="regEmail" placeholder="Enter your email">
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="regPassword" placeholder="Create a password">
            </div>
            <div class="form-group">
                <label>Role</label>
                <select id="regRole">
                    <option value="client">Client</option>
                    <option value="consultant">Consultant</option>
                </select>
            </div>
            <button class="btn btn-primary" style="width: 100%;" onclick="register()">Register</button>
            <div id="registerError" class="error"></div>
            <div id="registerSuccess" class="success"></div>
            <p style="text-align: center; margin-top: 20px;">
                Already have an account? <a href="#" onclick="showLogin(); return false;">Login</a>
            </p>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="dashboard container">
        <div class="header">
            <h1>IT Consulting Portal</h1>
            <div class="user-info">
                <span id="userName"></span>
                <button class="btn btn-secondary" onclick="logout()">Logout</button>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <h3>Open Tickets</h3>
                <div class="number" id="openTickets">0</div>
            </div>
            <div class="stat-card">
                <h3>In Progress</h3>
                <div class="number" id="inProgressTickets">0</div>
            </div>
            <div class="stat-card">
                <h3>Closed Tickets</h3>
                <div class="number" id="closedTickets">0</div>
            </div>
            <div class="stat-card">
                <h3>Total Tickets</h3>
                <div class="number" id="totalTickets">0</div>
            </div>
        </div>

        <div class="tickets-section">
            <div class="tickets-header">
                <h2>Tickets</h2>
                <button class="btn btn-success" onclick="showNewTicketModal()">New Ticket</button>
            </div>
            <div id="ticketsList" class="loading">Loading tickets...</div>
        </div>
    </div>

    <!-- New Ticket Modal -->
    <div id="newTicketModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Create New Ticket</h2>
                <button class="close-btn" onclick="closeNewTicketModal()">&times;</button>
            </div>
            <div class="form-group">
                <label>Title</label>
                <input type="text" id="ticketTitle" placeholder="Brief description of the issue">
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea id="ticketDescription" placeholder="Detailed description of the issue"></textarea>
            </div>
            <div class="form-group">
                <label>Priority</label>
                <select id="ticketPriority">
                    <option value="low">Low</option>
                    <option value="medium" selected>Medium</option>
                    <option value="high">High</option>
                    <option value="urgent">Urgent</option>
                </select>
            </div>
            <div class="form-group">
                <label>Category</label>
                <select id="ticketCategory">
                    <option value="general">General</option>
                    <option value="network">Network</option>
                    <option value="email">Email</option>
                    <option value="hardware">Hardware</option>
                    <option value="software">Software</option>
                    <option value="security">Security</option>
                    <option value="licensing">Licensing</option>
                </select>
            </div>
            <button class="btn btn-success" onclick="createTicket()">Create Ticket</button>
            <div id="newTicketError" class="error"></div>
        </div>
    </div>

    <!-- Ticket Detail Modal -->
    <div id="ticketDetailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="detailTitle">Ticket Details</h2>
                <button class="close-btn" onclick="closeTicketDetailModal()">&times;</button>
            </div>
            <div id="ticketDetailContent"></div>
            <div class="comments-section">
                <h3>Comments</h3>
                <div id="commentsList"></div>
                <div class="form-group" style="margin-top: 20px;">
                    <textarea id="newComment" placeholder="Add a comment..."></textarea>
                </div>
                <button class="btn btn-primary" onclick="addComment()">Add Comment</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:3000/api'; // Change this for production
        let currentUser = null;
        let currentTicketId = null;

        // Check if user is logged in
        function checkAuth() {
            const token = localStorage.getItem('token');
            const user = localStorage.getItem('user');
            
            if (token && user) {
                currentUser = JSON.parse(user);
                showDashboard();
                loadDashboard();
            }
        }

        // Show/Hide sections
        function showDashboard() {
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('dashboard').classList.add('active');
            document.getElementById('userName').textContent = currentUser.full_name;
        }

        function showAuth() {
            document.getElementById('authContainer').style.display = 'block';
            document.getElementById('dashboard').classList.remove('active');
        }

        function showLogin() {
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('registerForm').classList.add('hidden');
        }

        function showRegister() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
        }

        // API calls
        async function apiCall(endpoint, method = 'GET', body = null) {
            const token = localStorage.getItem('token');
            const headers = {
                'Content-Type': 'application/json',
            };
            
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }

            const options = {
                method,
                headers,
            };

            if (body) {
                options.body = JSON.stringify(body);
            }

            const response = await fetch(`${API_URL}${endpoint}`, options);
            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || 'Request failed');
            }

            return data;
        }

        // Auth functions
        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const errorEl = document.getElementById('loginError');

            try {
                const data = await apiCall('/auth/login', 'POST', { email, password });
                localStorage.setItem('token', data.token);
                localStorage.setItem('user', JSON.stringify(data.user));
                currentUser = data.user;
                showDashboard();
                loadDashboard();
            } catch (error) {
                errorEl.textContent = error.message;
            }
        }

        async function register() {
            const full_name = document.getElementById('regName').value;
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;
            const role = document.getElementById('regRole').value;
            const errorEl = document.getElementById('registerError');
            const successEl = document.getElementById('registerSuccess');

            try {
                await apiCall('/auth/register', 'POST', { email, password, full_name, role });
                successEl.textContent = 'Registration successful! Please login.';
                errorEl.textContent = '';
                setTimeout(() => {
                    showLogin();
                    successEl.textContent = '';
                }, 2000);
            } catch (error) {
                errorEl.textContent = error.message;
                successEl.textContent = '';
            }
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            currentUser = null;
            showAuth();
            showLogin();
        }

        // Dashboard functions
        async function loadDashboard() {
            await loadStats();
            await loadTickets();
        }

        async function loadStats() {
            try {
                const stats = await apiCall('/dashboard/stats');
                document.getElementById('openTickets').textContent = stats.open_tickets || 0;
                document.getElementById('inProgressTickets').textContent = stats.in_progress_tickets || 0;
                document.getElementById('closedTickets').textContent = stats.closed_tickets || 0;
                document.getElementById('totalTickets').textContent = stats.total_tickets || 0;
            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        }

        async function loadTickets() {
            const listEl = document.getElementById('ticketsList');
            listEl.innerHTML = '<div class="loading">Loading tickets...</div>';

            try {
                const tickets = await apiCall('/tickets');
                
                if (tickets.length === 0) {
                    listEl.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">No tickets found</p>';
                    return;
                }

                const ticketHTML = tickets.map(ticket => `
                    <div class="ticket-item" onclick="viewTicket(${ticket.ticket_id})">
                        <div class="ticket-header">
                            <div class="ticket-title">${ticket.title}</div>
                            <div class="ticket-badges">
                                <span class="badge badge-${ticket.priority}">${ticket.priority.toUpperCase()}</span>
                                <span class="badge badge-${ticket.status}">${ticket.status.replace('_', ' ').toUpperCase()}</span>
                            </div>
                        </div>
                        <div class="ticket-description">${ticket.description.substring(0, 150)}${ticket.description.length > 150 ? '...' : ''}</div>
                        <div class="ticket-meta">
                            <strong>Client:</strong> ${ticket.client_name} | 
                            <strong>Category:</strong> ${ticket.category} | 
                            <strong>Created:</strong> ${new Date(ticket.created_at).toLocaleDateString()}
                            ${ticket.assigned_to_name ? ` | <strong>Assigned to:</strong> ${ticket.assigned_to_name}` : ''}
                        </div>
                    </div>
                `).join('');

                listEl.innerHTML = `<ul class="ticket-list">${ticketHTML}</ul>`;
            } catch (error) {
                listEl.innerHTML = `<p style="color: #dc3545; text-align: center; padding: 20px;">Failed to load tickets: ${error.message}</p>`;
            }
        }

        // Ticket modal functions
        function showNewTicketModal() {
            document.getElementById('newTicketModal').classList.add('active');
        }

        function closeNewTicketModal() {
            document.getElementById('newTicketModal').classList.remove('active');
            document.getElementById('ticketTitle').value = '';
            document.getElementById('ticketDescription').value = '';
            document.getElementById('ticketPriority').value = 'medium';
            document.getElementById('ticketCategory').value = 'general';
            document.getElementById('newTicketError').textContent = '';
        }

        async function createTicket() {
            const title = document.getElementById('ticketTitle').value;
            const description = document.getElementById('ticketDescription').value;
            const priority = document.getElementById('ticketPriority').value;
            const category = document.getElementById('ticketCategory').value;
            const errorEl = document.getElementById('newTicketError');

            if (!title || !description) {
                errorEl.textContent = 'Please fill in all fields';
                return;
            }

            try {
                await apiCall('/tickets', 'POST', { title, description, priority, category });
                closeNewTicketModal();
                loadDashboard();
            } catch (error) {
                errorEl.textContent = error.message;
            }
        }

        async function viewTicket(ticketId) {
            currentTicketId = ticketId;
            const modal = document.getElementById('ticketDetailModal');
            const contentEl = document.getElementById('ticketDetailContent');
            
            modal.classList.add('active');
            contentEl.innerHTML = '<div class="loading">Loading ticket details...</div>';

            try {
                const ticket = await apiCall(`/tickets/${ticketId}`);
                
                contentEl.innerHTML = `
                    <div class="ticket-badges" style="margin-bottom: 20px;">
                        <span class="badge badge-${ticket.priority}">${ticket.priority.toUpperCase()}</span>
                        <span class="badge badge-${ticket.status}">${ticket.status.replace('_', ' ').toUpperCase()}</span>
                        <span class="badge">${ticket.category}</span>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <p>${ticket.description}</p>
                    </div>
                    <div class="form-group">
                        <label>Client</label>
                        <p>${ticket.client_name}</p>
                    </div>
                    <div class="form-group">
                        <label>Assigned To</label>
                        <p>${ticket.assigned_to_name || 'Unassigned'}</p>
                    </div>
                    <div class="form-group">
                        <label>Created</label>
                        <p>${new Date(ticket.created_at).toLocaleString()}</p>
                    </div>
                    ${ticket.resolution_notes ? `
                    <div class="form-group">
                        <label>Resolution Notes</label>
                        <p>${ticket.resolution_notes}</p>
                    </div>
                    ` : ''}
                    ${currentUser.role !== 'client' ? `
                    <div class="form-group">
                        <label>Update Status</label>
                        <select id="updateStatus" onchange="updateTicketStatus()">
                            <option value="open" ${ticket.status === 'open' ? 'selected' : ''}>Open</option>
                            <option value="in_progress" ${ticket.status === 'in_progress' ? 'selected' : ''}>In Progress</option>
                            <option value="pending" ${ticket.status === 'pending' ? 'selected' : ''}>Pending</option>
                            <option value="closed" ${ticket.status === 'closed' ? 'selected' : ''}>Closed</option>
                        </select>
                    </div>
                    ` : ''}
                `;

                await loadComments(ticketId);
            } catch (error) {
                contentEl.innerHTML = `<p style="color: #dc3545;">Failed to load ticket: ${error.message}</p>`;
            }
        }

        function closeTicketDetailModal() {
            document.getElementById('ticketDetailModal').classList.remove('active');
            currentTicketId = null;
        }

        async function updateTicketStatus() {
            const status = document.getElementById('updateStatus').value;
            
            try {
                await apiCall(`/tickets/${currentTicketId}`, 'PUT', { status });
                loadDashboard();
            } catch (error) {
                alert('Failed to update ticket: ' + error.message);
            }
        }

        async function loadComments(ticketId) {
            const listEl = document.getElementById('commentsList');
            listEl.innerHTML = '<div class="loading">Loading comments...</div>';

            try {
                const comments = await apiCall(`/tickets/${ticketId}/comments`);
                
                if (comments.length === 0) {
                    listEl.innerHTML = '<p style="color: #999;">No comments yet</p>';
                    return;
                }

                const commentsHTML = comments.map(comment => `
                    <div class="comment">
                        <div class="comment-header">${comment.author_name}</div>
                        <div>${comment.comment_text}</div>
                        <div class="comment-time">${new Date(comment.created_at).toLocaleString()}</div>
                    </div>
                `).join('');

                listEl.innerHTML = commentsHTML;
            } catch (error) {
                listEl.innerHTML = `<p style="color: #dc3545;">Failed to load comments</p>`;
            }
        }

        async function addComment() {
            const commentText = document.getElementById('newComment').value;
            
            if (!commentText.trim()) {
                alert('Please enter a comment');
                return;
            }

            try {
                await apiCall(`/tickets/${currentTicketId}/comments`, 'POST', { comment_text: commentText });
                document.getElementById('newComment').value = '';
                await loadComments(currentTicketId);
            } catch (error) {
                alert('Failed to add comment: ' + error.message);
            }
        }

        // Initialize
        checkAuth();
    </script>
</body>
</html>
